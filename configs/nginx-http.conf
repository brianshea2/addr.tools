js_path /data/addr.tools/website/njs;
js_import main.js;
limit_req_status 429;
limit_req_zone $binary_remote_addr zone=updates:10m rate=1r/s;
client_max_body_size 32k;

##
## addr.tools
##
server {
    include listen_https.conf;
    server_name addr.tools;
    root /data/addr.tools/website/addr.tools;
    ssl_certificate /data/letsencrypt/live/addr.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/addr.tools/privkey.pem;
    location / {
        index index.html;
        try_files $uri $uri.html $uri/ =404;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Cache-Control "max-age=3600, must-revalidate";
        add_header Vary "Accept-Encoding";
    }
    location /js/ {
        try_files $uri $uri.js =404;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Access-Control-Allow-Origin "*";
        add_header Cache-Control "max-age=3600, must-revalidate";
        add_header Vary "Accept-Encoding";
    }
    location = /favicon.ico {
        rewrite ^ /favicon.svg last;
    }
    include custom_errors.conf;
    location = /.error_page {
        internal;
        add_header Strict-Transport-Security "max-age=31536000" always;
        default_type text/html;
        return 200 $error_page_body;
    }
}
server {
    include listen_https.conf;
    server_name www.addr.tools;
    ssl_certificate /data/letsencrypt/live/addr.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/addr.tools/privkey.pem;
    location / {
        error_page 301 @redirect;
        return 301 https://addr.tools$request_uri;
    }
    location @redirect {
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Cache-Control "max-age=2592000";
        return 200 "Please use addr.tools\n";
    }
}

##
## challenges.addr.tools
##
server {
    include listen_https.conf;
    server_name challenges.addr.tools;
    root /data/addr.tools/website/challenges.addr.tools;
    ssl_certificate /data/letsencrypt/live/addr.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/addr.tools/privkey.pem;
    location / {
        try_files $uri $uri.html =404;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Cache-Control "max-age=3600, must-revalidate";
        add_header Vary "Accept-Encoding";
    }
    location = / {
        try_files /help.html =404;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Cache-Control "max-age=3600, must-revalidate";
        add_header Vary "Accept-Encoding";
        if ($is_args = "?") {
            error_page 418 = @challenges;
            return 418;
        }
        if ($request_method ~ ^(?:POST|PUT|DELETE)$) {
            error_page 418 = @challenges;
            return 418;
        }
    }
    location @challenges {
        limit_req zone=updates burst=100 nodelay;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Access-Control-Allow-Origin "*" always;
        add_header Cache-Control "no-store";
        proxy_pass http://unix:/data/addrd/addrd.sock:/challenges$is_args$args;
        proxy_set_header X-Real-IP $remote_addr;
    }
    location = /favicon.ico {
        rewrite ^ /favicon.svg last;
    }
    include custom_errors.conf;
    location = /.error_page {
        internal;
        add_header Strict-Transport-Security "max-age=31536000" always;
        default_type text/html;
        return 200 $error_page_body;
    }
}

##
## cname.addr.tools
##
server {
    include listen_https.conf;
    server_name cname.addr.tools;
    root /data/addr.tools/website/cname.addr.tools;
    ssl_certificate /data/letsencrypt/live/addr.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/addr.tools/privkey.pem;
    location / {
        index help.html;
        try_files $uri $uri.html $uri/ =404;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Cache-Control "max-age=3600, must-revalidate";
        add_header Vary "Accept-Encoding";
    }
    location = /favicon.ico {
        rewrite ^ /favicon.svg last;
    }
    include custom_errors.conf;
    location = /.error_page {
        internal;
        add_header Strict-Transport-Security "max-age=31536000" always;
        default_type text/html;
        return 200 $error_page_body;
    }
}

##
## dnscheck.tools
##
server {
    include listen_https.conf;
    server_name dnscheck.tools;
    root /data/addr.tools/website/dnscheck.tools;
    ssl_certificate /data/letsencrypt/live/dnscheck.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/dnscheck.tools/privkey.pem;
    location / {
        index index.html;
        try_files $uri $uri.html $uri/ =404;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Cache-Control "max-age=3600, must-revalidate";
        add_header Vary "Accept-Encoding";
    }
    location ~ "^/watch(?:/[0-9a-f]{1,8})?$" {
        try_files /watch.html =404;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Cache-Control "no-store";
        add_header X-Robots-Tag "noindex";
    }
    location = /favicon.ico {
        rewrite ^ /favicon.svg last;
    }
    include custom_errors.conf;
    location = /.error_page {
        internal;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        default_type text/html;
        return 200 $error_page_body;
    }
}
server {
    include listen_https.conf;
    server_name www.dnscheck.tools;
    ssl_certificate /data/letsencrypt/live/dnscheck.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/dnscheck.tools/privkey.pem;
    location / {
        error_page 301 @redirect;
        return 301 https://dnscheck.tools$request_uri;
    }
    location @redirect {
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Cache-Control "max-age=2592000";
        return 200 "Please use dnscheck.tools\n";
    }
}
server {
    http2 off;
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name ws.dnscheck.tools;
    ssl_certificate /data/letsencrypt/live/dnscheck.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/dnscheck.tools/privkey.pem;
    location / {
        return 400;
    }
    location ~ "^/watch/[0-9a-f]{1,8}$" {
        if ($http_connection !~* "(?:^|, *)upgrade(?:,|$)") {
            return 400;
        }
        if ($http_upgrade != "websocket") {
            return 400;
        }
        add_header Strict-Transport-Security "max-age=31536000" always;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_pass http://unix:/data/addrd/addrd.sock:;
        proxy_read_timeout 125s;
        proxy_set_header Connection "upgrade";
        proxy_set_header Upgrade "websocket";
        proxy_set_header X-Real-IP $remote_addr;
    }
    include custom_errors.conf;
    location = /.error_page {
        internal;
        add_header Strict-Transport-Security "max-age=31536000" always;
        default_type text/html;
        return 200 $error_page_body;
    }
}
server {
    include listen_http.conf;
    include listen_https.conf;
    server_name .test.dnscheck.tools          .test-ipv4.dnscheck.tools          .test-ipv6.dnscheck.tools
                .test-alg13.dnscheck.tools    .test-alg13-ipv4.dnscheck.tools    .test-alg13-ipv6.dnscheck.tools
                .test-alg14.dnscheck.tools    .test-alg14-ipv4.dnscheck.tools    .test-alg14-ipv6.dnscheck.tools
                .test-alg15.dnscheck.tools    .test-alg15-ipv4.dnscheck.tools    .test-alg15-ipv6.dnscheck.tools
                .go.dnscheck.tools;
    keepalive_requests 1;
    ssl_certificate /data/letsencrypt/live/dnscheck.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/dnscheck.tools/privkey.pem;
    location = / {
        add_header Access-Control-Allow-Origin "*";
        add_header Cache-Control "no-store";
        add_header X-Robots-Tag "noindex";
        return 200 "Connected\n";
    }
    location / {
        return 404;
    }
    include custom_errors.conf;
    location = /.error_page {
        internal;
        default_type text/html;
        return 200 $error_page_body;
    }
}

##
## dyn.addr.tools
##
server {
    include listen_https.conf;
    server_name dyn.addr.tools ipv4.dyn.addr.tools ipv6.dyn.addr.tools;
    root /data/addr.tools/website/dyn.addr.tools;
    ssl_certificate /data/letsencrypt/live/addr.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/addr.tools/privkey.pem;
    location / {
        try_files $uri $uri.html =404;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Cache-Control "max-age=3600, must-revalidate";
        add_header Vary "Accept-Encoding";
    }
    location = / {
        try_files /help.html =404;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Cache-Control "max-age=3600, must-revalidate";
        add_header Vary "Accept-Encoding";
        if ($is_args = "?") {
            error_page 418 = @dyn;
            return 418;
        }
        if ($request_method ~ ^(?:POST|PUT|DELETE)$) {
            error_page 418 = @dyn;
            return 418;
        }
    }
    location @dyn {
        limit_req zone=updates burst=10 nodelay;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Access-Control-Allow-Origin "*" always;
        add_header Cache-Control "no-store";
        proxy_pass http://unix:/data/addrd/addrd.sock:/dyn$is_args$args;
        proxy_set_header X-Real-IP $remote_addr;
    }
    location = /favicon.ico {
        rewrite ^ /favicon.svg last;
    }
    include custom_errors.conf;
    location = /.error_page {
        internal;
        add_header Strict-Transport-Security "max-age=31536000" always;
        default_type text/html;
        return 200 $error_page_body;
    }
}

##
## header-echo.addr.tools
##
server {
    include listen_http.conf;
    include listen_https.conf;
    server_name .header-echo.addr.tools;
    root /data/addr.tools/website/header-echo.addr.tools;
    ssl_certificate /data/letsencrypt/live/addr.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/addr.tools/privkey.pem;
    location / {
        try_files $uri $uri.html @echo;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Cache-Control "max-age=3600, must-revalidate";
        add_header Vary "Accept-Encoding";
    }
    location @echo {
        js_content main.header_echo_content;
        js_header_filter main.header_echo;
    }
    location = /favicon.ico {
        rewrite ^ /favicon.svg last;
    }
    include custom_errors.conf;
    location = /.error_page {
        internal;
        default_type text/html;
        return 200 $error_page_body;
    }
}

##
## info.addr.tools
##
map $http_cf_connecting_ip $real_remote_addr {
    default $http_cf_connecting_ip;
    "" $remote_addr;
}
server {
    include listen_https.conf;
    server_name info.addr.tools;
    root /data/addr.tools/website/info.addr.tools;
    ssl_certificate /data/letsencrypt/live/addr.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/addr.tools/privkey.pem;
    location ~ "\\.(?:html|js|css|ico|png|svg|txt)$" {
        try_files $uri =404;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Cache-Control "max-age=3600, must-revalidate";
        add_header Vary "Accept-Encoding";
    }
    location / {
        index help.html;
        try_files $uri $uri.html $uri/ @info;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Cache-Control "max-age=3600, must-revalidate";
        add_header Vary "Accept-Encoding";
    }
    location @info {
        try_files /info.html =404;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Cache-Control "no-store";
        add_header X-Robots-Tag "noindex";
    }
    location = /me {
        error_page 302 @me;
        return 302 https://info.addr.tools/$real_remote_addr;
    }
    location @me {
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Cache-Control "no-store";
        return 200 "$real_remote_addr\n";
    }
    location ~ "^/dns/[0-9A-Za-z._-]+/[0-9A-Za-z]+$" {
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Vary "Accept-Encoding";
        proxy_pass http://unix:/data/addrd/addrd.sock:;
        proxy_set_header X-Real-IP $remote_addr;
    }
    location = /favicon.ico {
        rewrite ^ /favicon.svg last;
    }
    include custom_errors.conf;
    location = /.error_page {
        internal;
        add_header Strict-Transport-Security "max-age=31536000" always;
        default_type text/html;
        return 200 $error_page_body;
    }
}

##
## ip.addr.tools
##
server {
    include listen_https.conf;
    server_name ip.addr.tools;
    root /data/addr.tools/website/ip.addr.tools;
    ssl_certificate /data/letsencrypt/live/addr.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/addr.tools/privkey.pem;
    location / {
        index help.html;
        try_files $uri $uri.html $uri/ =404;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Cache-Control "max-age=3600, must-revalidate";
        add_header Vary "Accept-Encoding";
    }
    location = /favicon.ico {
        rewrite ^ /favicon.svg last;
    }
    include custom_errors.conf;
    location = /.error_page {
        internal;
        add_header Strict-Transport-Security "max-age=31536000" always;
        default_type text/html;
        return 200 $error_page_body;
    }
}
server {
    include listen_http.conf;
    include listen_https.conf;
    server_name self.ip.addr.tools self6.ip.addr.tools;
    ssl_certificate /data/letsencrypt/live/addr.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/addr.tools/privkey.pem;
    js_set $self_host main.get_self_ip_host;
    location / {
        error_page 302 @redirect;
        return 302 $scheme://$self_host$request_uri;
    }
    location @redirect {
        add_header Cache-Control "no-store";
        return 200 "$self_host\n";
    }
}

##
## myaddr.tools
##
server {
    include listen_https.conf;
    server_name ~^www\.(?<myaddr_host>myaddr\.tools|myaddr\.dev|myaddr\.io)$;
    ssl_certificate /data/letsencrypt/live/myaddr.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/myaddr.tools/privkey.pem;
    location / {
        error_page 301 @redirect;
        return 301 https://$myaddr_host$request_uri;
    }
    location @redirect {
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Cache-Control "max-age=2592000";
        return 200 "Please use $myaddr_host\n";
    }
}
server {
    include listen_https.conf;
    server_name myaddr.tools ipv4.myaddr.tools ipv6.myaddr.tools
                myaddr.dev   ipv4.myaddr.dev   ipv6.myaddr.dev
                myaddr.io    ipv4.myaddr.io    ipv6.myaddr.io;
    root /data/addr.tools/website/myaddr.tools;
    ssl_certificate /data/letsencrypt/live/myaddr.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/myaddr.tools/privkey.pem;
    location / {
        index index.html;
        try_files $uri $uri.html $uri/ =404;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Content-Security-Policy "frame-ancestors 'none'";
        add_header Cache-Control "max-age=3600, must-revalidate";
        add_header Vary "Accept-Encoding";
    }
    location = /reg {
        limit_req zone=updates burst=10 nodelay;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Access-Control-Allow-Origin "*" always;
        add_header Cache-Control "no-store";
        proxy_pass http://unix:/data/addrd/addrd.sock:/myaddr-reg$is_args$args;
        proxy_set_header X-Real-IP $remote_addr;
    }
    location = /update {
        limit_req zone=updates burst=10 nodelay;
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Access-Control-Allow-Origin "*" always;
        add_header Cache-Control "no-store";
        proxy_pass http://unix:/data/addrd/addrd.sock:/myaddr-update$is_args$args;
        proxy_set_header X-Real-IP $remote_addr;
    }
    location = /favicon.ico {
        rewrite ^ /favicon.svg last;
    }
    include custom_errors.conf;
    location = /.error_page {
        internal;
        add_header Strict-Transport-Security "max-age=31536000" always;
        default_type text/html;
        return 200 $error_page_body;
    }
}

##
## myip.addr.tools
##
map $arg_key $myip_json_key {
    default ip;
    "~^[a-zA-Z_$][0-9a-zA-Z_$]*$" $arg_key;
}
server {
    include listen_http.conf;
    include listen_https.conf;
    server_name myip.addr.tools myipv4.addr.tools myipv6.addr.tools;
    root /data/addr.tools/website/myip.addr.tools;
    ssl_certificate /data/letsencrypt/live/addr.tools/fullchain.pem;
    ssl_certificate_key /data/letsencrypt/live/addr.tools/privkey.pem;
    location / {
        try_files $uri $uri.html =404;
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Cache-Control "max-age=3600, must-revalidate";
        add_header Vary "Accept-Encoding";
    }
    location = / {
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Access-Control-Allow-Origin "*";
        add_header Cache-Control "no-store";
        return 200 "$remote_addr\n";
    }
    location = /plain {
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Access-Control-Allow-Origin "*";
        add_header Cache-Control "no-store";
        return 200 $remote_addr;
    }
    location = /json {
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Access-Control-Allow-Origin "*";
        add_header Cache-Control "no-store";
        default_type application/json;
        return 200 "{\"$myip_json_key\":\"$remote_addr\"}";
    }
    location = /pfsense {
        add_header Alt-Svc 'h3=":443"; ma=2592000';
        add_header Access-Control-Allow-Origin "*";
        add_header Cache-Control "no-store";
        default_type text/html;
        return 200 "<html><head><title>Current IP Check</title></head><body>Current IP Address: $remote_addr</body></html>\n";
    }
    location = /favicon.ico {
        rewrite ^ /favicon.svg last;
    }
    include custom_errors.conf;
    location = /.error_page {
        internal;
        default_type text/html;
        return 200 $error_page_body;
    }
}
